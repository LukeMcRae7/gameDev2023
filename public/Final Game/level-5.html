<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Level 5</title>
<style>
  .platform {
    position: absolute;
    background-color: #333;
  }
</style>
<script>
  // global variables here
  let myGlobalX = 0;
  let myClock;
  let myInterval = 0;
  let jumping = false;
  let gravity = 0.6;
  let vy = 0;
  let moveSpeed = 5;
  let jumpForce = -13;
  let moveLeft = false;
  let moveRight = false;
  let lastMoveDirection = 'right';
  let speedBoostTimeout = null;

  let isDead = 0;

let imgIdleLeft = "idleLeft.gif";
let imgIdleRight = "idleRight.gif";
let imgMovingLeft = "movingLeft.gif";
let imgMovingRight = "movingRight.gif";
let imgJumpingLeft = "jumpingLeft.png";
let imgJumpingRight = "jumpingRight.png";

let hitboxAdjustmentLeft = 17;
let hitboxAdjustmentRight = 17;
let hitboxAdjustmentTop = 30;
let hitboxAdjustmentBottom = 10;

  // global functions here
  function myHitOther(my1, my2) {
  left1   = parseInt(document.getElementById(my1).style.left) + hitboxAdjustmentLeft;
  right1  = left1 + parseInt(document.getElementById(my1).style.width) - hitboxAdjustmentRight;
  top1    = parseInt(document.getElementById(my1).style.top) + hitboxAdjustmentTop;
  bottom1 = top1   + parseInt(document.getElementById(my1).style.height) - hitboxAdjustmentBottom;
  left2   = parseInt(document.getElementById(my2).style.left) + hitboxAdjustmentLeft;
  right2  = left2 + parseInt(document.getElementById(my2).style.width) - hitboxAdjustmentRight;
  top2    = parseInt(document.getElementById(my2).style.top) + hitboxAdjustmentTop;
  bottom2 = top2   + parseInt(document.getElementById(my2).style.height) - hitboxAdjustmentBottom;

    if(my2 === "myImg02" || my2 === "myImg02-2" || my2 === "myImg02-3" || my2 === "myImg02-4" || my2 === "myImg02-5" || my2 === "myImg02-6" || my2 === "myImg02-7" || my2 === "myImg02-8" || my2 === "myImg02-9" || my2 === "myImg02-10" || my2 === "myImg02-11" || my2 === "myImg02-12") {
      // These are your spike images. Adjust the hitbox as needed.
      left2   = parseInt(document.getElementById(my2).style.left) + hitboxAdjustmentLeft;
      right2  = left2 + parseInt(document.getElementById(my2).style.width) - hitboxAdjustmentRight;
      top2    = parseInt(document.getElementById(my2).style.top) + hitboxAdjustmentTop;   
      bottom2 = top2   + parseInt(document.getElementById(my2).style.height) - hitboxAdjustmentBottom;
    } else {
      // These are your other images. No adjustment needed.
      left2   = parseInt(document.getElementById(my2).style.left);
      right2  = left2 + parseInt(document.getElementById(my2).style.width);
      top2    = parseInt(document.getElementById(my2).style.top);   
      bottom2 = top2   + parseInt(document.getElementById(my2).style.height);
    }

    if ((right1  >=  left2  ) &&      	   
       (bottom1 >=  top2   ) &&
       (left1   <=  right2 ) &&
       (top1    <=  bottom2) ){
       return true
    }
  }

  function myCheckHit() {
  if (myHitOther('myImg01', 'myImg02') || myHitOther('myImg01', 'myImg02-2') || myHitOther('myImg01', 'myImg02-3') || myHitOther('myImg01', 'myImg02-4') || myHitOther('myImg01', 'myImg02-5') || myHitOther('myImg01', 'myImg02-6') || myHitOther('myImg01', 'myImg02-7') || myHitOther('myImg01', 'myImg02-8') || myHitOther('myImg01', 'myImg02-9') || myHitOther('myImg01', 'myImg02-10') || myHitOther('myImg01', 'myImg02-11') || myHitOther('myImg01', 'myImg02-12')) {
    imgIdleLeft = "deathLeft.gif"
    imgIdleRight = "deathRight.gif"
    isDead = 1;
    moveRight = false;
    moveLeft = false;
    const myDeathTimeout = setTimeout(myDeath, 700)
    function myDeath() {
      location = 'level-5.html';
    }
  }
  if (myHitOther('myImg01', 'myImg04')) {
    location = 'win.html';
  }
}
  let grounded = false;
  function gameLoop() {
  let player = document.getElementById("myImg01");

  if (moveLeft !== moveRight) {
    if (moveLeft) {
      player.style.left = parseInt(player.style.left) - moveSpeed + 'px';
    } else if (moveRight) {
      player.style.left = parseInt(player.style.left) + moveSpeed + 'px';
    }
  }

  vy += gravity;
  player.style.top = parseInt(player.style.top) + vy + "px";

  checkCollisions();

  updatePlayerImage();

  myCheckHit();

  requestAnimationFrame(gameLoop);
}



function checkCollisions() {
  let player = document.getElementById("myImg01");
  grounded = false;

  let platforms = ['platform1','platform2','platform3','platform4','platform5','platform6','platform7','platform8','platform9','platform10','platform11','platform12'];

  for (let i = 0; i < platforms.length; i++) {
    let platform = document.getElementById(platforms[i]);
    let platformLeft = parseInt(platform.style.left);
    let platformRight = platformLeft + parseInt(platform.style.width);
    let platformTop = parseInt(platform.style.top);
    let platformBottom = platformTop + parseInt(platform.style.height);

    let playerLeft = parseInt(player.style.left);
    let playerRight = playerLeft + parseInt(player.style.width);
    let playerTop = parseInt(player.style.top);
    let playerBottom = playerTop + parseInt(player.style.height);

    let horizontalCollision = playerRight >= platformLeft && playerLeft <= platformRight;
    let verticalCollision = playerBottom >= platformTop && playerTop <= platformBottom;

    if (horizontalCollision && verticalCollision) {
      let topOverlap = playerBottom - platformTop;
      let bottomOverlap = platformBottom - playerTop;
      let leftOverlap = playerRight - platformLeft;
      let rightOverlap = platformRight - playerLeft;

      let minOverlap = Math.min(topOverlap, bottomOverlap, leftOverlap, rightOverlap);

      if (minOverlap === topOverlap) {
        player.style.top = platformTop - parseInt(player.style.height) + 'px';
        vy = 0;
        jumping = false;
        grounded = true;
      } else if (minOverlap === bottomOverlap) {
        player.style.top = platformBottom + 'px';
        vy = 1;
      } else {
        if (minOverlap === leftOverlap) {
          player.style.left = platformLeft - parseInt(player.style.width) + 'px';
        } else if (minOverlap === rightOverlap) {
          player.style.left = platformRight + 'px';
        }
      }
    }
  }
}

let currentImage = '';

function updatePlayerImage() {
  let player = document.getElementById("myImg01");
  let newImage = '';

  if (jumping) {
    if (moveLeft || (!moveLeft && !moveRight && lastMoveDirection === 'left')) {
      newImage = imgJumpingLeft;
    } else if (moveRight || (!moveLeft && !moveRight && lastMoveDirection === 'right')) {
      newImage = imgJumpingRight;
    }
  } else {
    if (moveLeft) {
      newImage = imgMovingLeft;
    } else if (moveRight) {
      newImage = imgMovingRight;
    } else {
      if (lastMoveDirection === 'left') {
        newImage = imgIdleLeft;
      } else {
        newImage = imgIdleRight;
      }
    }
  }

  if (currentImage !== newImage) {
    player.src = newImage;
    currentImage = newImage;
  }
}


function handleKeydown(event) {
  let myKey = event.key;
  if (isDead == 1) {}
  else if (myKey === 'd') {
    moveRight = true;
    lastMoveDirection = 'right';
  } else if (myKey === 'a') {
    moveLeft = true;
    lastMoveDirection = 'left';
  } else if (myKey === ' ' && !jumping && grounded) {
    jumping = true;
    vy = jumpForce;
  }
}

function handleKeyup(event) {
  let myKey = event.key;
  if (isDead == 1) {}
  else if (myKey === 'd') {
    moveRight = false;
  } else if (myKey === 'a') {
    moveLeft = false;
  }
}

  window.addEventListener("keydown", handleKeydown);
  window.addEventListener("keyup", handleKeyup);
</script>
</head>
<body id="myBody" style="background-repeat:repeat; background-size: 100%" background="myBackground01.jpg" onload="{
  document.getElementById('myImg01').style.left = '215px';
  document.getElementById('myImg01').style.top = '636px';
  gameLoop();
}">
  <br><br><br><br>
  <div id="top" style="position: absolute; width:1600px; height:1px; top:0px; left:0px;"></div>
  <div id="platform1" class="platform" style="width:13px; height:744px; top:0px; left:0px;"></div>
  <div id="platform2" class="platform" style="width:13px; height:744px; top:0px; left:1587px;"></div>
  <div id="platform3" class="platform" style="width:1600px; height:13px; top:744px; left:0px;"></div>
  <div id="platform4" class="platform" style="width:234px; height:13px; top:151px; left:350px;"></div>
  <div id="platform5" class="platform" style="width:230px; height:13px; top:281px; left:201px;"></div>
  <div id="platform6" class="platform" style="width:200px; height:70px; top:676px; left:270px;"></div>
  <div id="platform7" style="width:80px; height:80px; top:676px; left:200px;"></div>
  <div id="platform8" class="platform" style="width:350px; height:13px; top:545px; left:550px;"></div>
  <div id="platform9" class="platform" style="width:134px; height:13px; top:420px; left:380px;"></div>
  <div id="platform10" class="platform" style="width:70px; height:13px; top:615px; left:1520px;"></div>
  <div id="platform11" class="platform" style="width:350px; height:13px; top:545px; left:1000px;"></div>
  <div id="platform12" class="platform" style="width:150px; height:13px; top:265px; left:720px;"></div>


  <img id="myImg02" style="position:absolute; width:45px; height:45px; top:700px; left:620px;" src="spike.png">
  <img id="myImg02-2" style="position:absolute; width:45px; height:45px; top:631px; left:320px;" src="spike.png">
  <img id="myImg02-3" style="position:absolute; width:45px; height:45px; top:631px; left:380px;" src="spike.png">
  <img id="myImg02-4" style="position:absolute; width:45px; height:45px; top:700px; left:800px;" src="spike.png">
  <img id="myImg02-5" style="position:absolute; width:45px; height:45px; top:700px; left:820px;" src="spike.png">
  <img id="myImg02-6" style="position:absolute; width:45px; height:45px; top:570px; left:1543px;" src="spike.png">
  <img id="myImg02-7" style="position:absolute; width:45px; height:65px; top:680px; left:1100px;" src="spike.png">
  <img id="myImg02-8" style="rotate: 180deg; position:absolute; width:45px; height:45px; top:278px; left:770px;" src="spike.png">
  <img id="myImg02-9" style="position:absolute; width:45px; height:45px; top:500px; left:770px;" src="spike.png">
  <img id="myImg02-10" style="position:absolute; width:45px; height:45px; top:500px; left:550px;" src="spike.png">
  <img id="myImg02-11" style="position:absolute; width:45px; height:45px; top:375px; left:430px;" src="spike.png">
  <img id="myImg02-12" style="position:absolute; width:45px; height:45px; top:375px; left:385px;" src="spike.png">

  <img id="myImg01" style="position:absolute; width:50px; height:90px; top:636px; left:215px;" src="idleRight.png">
  <img id="myImg03" style="position:absolute; width:80px; height:80px; top:676px; left:200px;" src="pipe.png">
  <img id="myImg04" style="position:absolute; width:80px; height:80px; top:50px; left:500px;" src="trophy.gif">
  <br><br>
</body>
</html>